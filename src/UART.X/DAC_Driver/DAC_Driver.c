#include "DAC_Driver.h"

uint32_t fsample = 22050;

double sawToothIncrement;
double sineIncrement;

unsigned int sawBufferSize = 0;
unsigned int *sawBuffer;

unsigned int sineBufferSize = 0;
unsigned int *sineBuffer;

unsigned short int soundFileLookupSize = 3370;
unsigned short int soundFileLookup[3370] = {127,127,128,126,129,123,137,143,155,145,125,135,116,125,115,114,137,124,130,117,112,128,113,128,130,142,157,135,137,125,114,128,100,120,130,138,143,115,115,99,103,117,130,166,169,153,139,105,108,99,104,131,141,162,136,118,100,86,104,106,140,169,174,166,131,110,99,91,107,124,152,167,140,125,91,87,95,99,145,162,184,169,131,117,88,96,101,122,158,160,152,119,94,87,85,105,136,168,190,167,140,110,86,96,95,129,156,166,156,115,96,78,84,104,133,176,188,173,142,106,89,86,96,128,157,173,156,120,95,73,82,96,131,176,188,182,142,111,87,82,96,120,159,174,158,127,96,76,78,91,128,170,190,183,147,116,89,82,92,118,158,172,161,129,98,79,74,92,123,168,190,183,152,118,91,82,89,116,155,172,164,132,102,78,73,88,121,165,190,184,158,128,104,91,90,118,151,173,164,130,107,79,72,82,109,159,185,183,160,134,117,102,96,118,149,172,163,128,107,86,75,80,100,145,173,174,159,137,125,104,98,112,138,165,154,132,113,94,84,79,97,131,161,168,155,147,136,114,106,104,130,153,144,138,117,110,91,80,95,115,157,159,157,154,139,126,105,105,124,143,148,135,126,116,95,83,89,110,150,153,160,155,145,131,104,106,116,139,147,136,134,119,102,85,82,108,136,154,157,160,153,134,109,103,108,135,142,139,141,126,112,83,82,99,127,152,153,167,158,140,116,98,107,126,138,142,141,136,115,88,81,93,121,144,153,169,162,147,119,99,104,119,137,140,146,141,119,94,79,89,115,137,152,169,168,150,124,101,100,115,132,138,148,144,127,97,78,87,106,133,149,168,172,153,129,102,98,109,126,137,149,150,133,104,81,84,102,125,147,167,175,160,134,106,97,104,120,136,148,154,138,109,82,81,97,117,145,166,177,166,137,109,97,101,114,133,150,156,144,114,85,80,92,112,141,163,180,170,143,113,98,98,110,130,148,159,148,119,88,80,88,108,136,163,179,175,149,115,99,96,105,126,146,160,153,123,94,79,86,102,133,159,180,177,153,120,101,94,102,121,143,160,158,129,98,82,84,97,128,155,179,179,156,125,102,93,99,117,139,160,160,134,102,85,82,93,123,153,177,180,159,130,104,92,96,113,136,157,164,139,108,88,83,90,118,148,174,182,161,136,108,93,95,110,133,156,165,144,113,92,84,88,112,145,170,182,163,140,112,94,94,107,128,152,165,148,118,94,85,86,109,140,167,180,167,142,118,95,93,104,125,149,162,152,122,99,86,86,105,136,162,179,167,146,122,99,92,103,120,144,160,154,127,104,88,87,102,131,158,176,169,150,126,104,93,100,118,138,158,154,134,109,92,87,99,125,154,172,172,152,132,108,93,100,113,136,154,156,139,115,97,87,97,119,148,170,173,157,137,114,96,99,110,131,151,155,142,124,103,91,96,114,141,164,171,160,143,119,102,98,108,125,146,153,144,130,108,92,95,108,136,159,169,161,147,124,105,98,104,120,143,151,146,133,113,95,95,104,130,155,168,162,150,128,107,99,101,116,139,149,148,136,118,97,95,100,124,153,165,165,154,133,109,101,97,112,135,147,149,140,124,101,96,97,117,148,164,165,157,136,114,101,96,107,132,144,150,143,129,106,96,95,109,143,161,166,160,142,118,103,94,103,127,143,149,148,132,112,96,93,106,136,160,167,163,148,123,105,95,99,124,139,149,150,138,116,99,90,102,130,157,166,166,151,128,106,94,96,119,137,150,152,142,121,99,90,97,125,152,166,167,156,133,108,93,94,115,134,149,155,146,125,101,89,93,121,147,165,170,160,137,111,93,94,110,130,148,155,152,129,105,88,90,115,143,164,171,164,142,114,93,92,107,127,144,158,153,136,108,89,88,110,137,160,170,167,145,116,95,90,107,121,143,157,157,141,112,91,88,106,134,155,171,170,150,122,96,91,104,119,139,157,160,145,117,93,87,103,128,150,170,170,155,125,101,91,102,116,133,154,161,146,122,94,88,100,122,147,168,171,157,129,103,93,100,114,130,155,162,148,125,96,89,97,117,143,167,172,157,132,105,92,99,110,129,152,164,151,127,101,87,96,112,139,165,174,160,134,108,93,97,109,126,151,164,154,129,104,89,93,109,134,163,174,162,138,111,95,95,107,125,148,164,156,133,107,90,91,105,130,160,174,164,139,116,96,94,103,123,146,164,159,137,112,92,91,101,126,157,173,167,142,120,98,94,101,121,145,161,161,140,116,96,91,97,122,151,171,168,146,124,102,96,99,117,141,157,161,143,122,101,91,97,116,146,167,167,150,126,107,96,99,115,138,154,160,145,126,103,94,97,113,144,161,167,151,128,110,95,99,113,136,151,159,148,129,107,95,96,111,139,159,167,153,133,111,98,98,109,133,149,158,149,132,113,96,96,109,135,155,164,156,135,116,99,98,108,130,146,156,150,134,118,99,97,108,131,151,162,156,138,120,101,98,107,126,145,154,151,136,121,103,98,107,127,146,159,156,141,123,104,99,106,123,140,150,151,138,125,109,100,107,122,142,154,154,143,126,111,102,107,121,135,147,148,139,127,113,104,108,122,139,149,153,144,130,115,104,108,119,132,143,148,139,130,117,107,107,118,133,146,151,145,134,118,108,106,117,129,140,146,142,131,122,110,108,116,129,143,148,147,137,122,109,106,113,126,136,146,143,134,123,112,108,113,126,139,148,148,140,124,111,106,112,123,133,144,144,136,126,114,108,113,122,137,146,147,142,128,112,107,110,121,132,141,145,138,128,117,109,113,120,135,142,147,143,131,116,108,111,118,130,138,144,140,131,121,113,114,120,129,138,144,142,136,120,110,111,116,125,133,141,142,134,125,115,115,118,124,135,141,144,139,124,114,109,114,121,130,140,144,139,128,117,115,116,121,131,140,146,141,129,114,110,113,118,127,138,144,141,131,120,115,115,118,127,139,146,145,133,117,110,110,115,123,135,147,145,133,122,114,113,117,124,137,147,147,135,119,111,110,114,120,135,146,147,135,123,115,113,115,123,137,147,148,136,121,111,111,112,120,132,146,147,137,124,117,113,115,121,134,145,148,137,123,113,111,112,116,130,144,148,139,128,118,115,113,119,130,144,149,138,126,115,111,110,113,126,141,146,141,131,121,117,113,117,129,141,148,141,128,119,112,110,110,125,140,146,143,133,123,117,112,114,127,141,147,142,130,120,114,108,110,122,138,145,143,134,125,117,113,112,127,138,147,143,131,121,114,108,109,120,138,146,142,136,125,119,112,112,126,138,146,143,133,123,114,109,108,119,135,145,142,137,127,120,113,111,124,139,145,145,134,125,114,108,106,117,134,144,143,138,130,121,113,110,122,137,145,143,137,127,116,109,105,115,130,142,143,138,132,125,116,110,119,134,143,143,138,128,119,108,105,112,128,139,143,139,135,127,118,112,118,133,141,143,138,130,122,109,106,112,125,138,141,139,135,127,119,111,118,130,141,143,139,132,122,110,105,110,125,135,141,139,136,129,119,112,117,129,141,143,140,135,123,112,104,109,122,134,139,140,137,130,120,114,117,127,141,144,142,136,125,113,102,108,120,133,138,139,140,130,121,115,115,126,137,144,144,139,127,114,104,107,118,132,137,141,141,132,122,115,117,125,136,143,143,140,127,115,104,106,116,129,134,140,140,135,123,117,117,123,133,140,143,140,130,118,107,105,114,124,132,138,141,137,124,118,117,122,131,138,143,143,132,119,108,106,112,123,131,138,142,137,125,118,116,123,129,136,143,142,135,120,110,105,111,121,129,138,143,138,127,118,117,121,128,136,142,144,136,121,111,105,111,117,128,138,144,139,129,118,117,122,126,136,142,146,137,124,112,105,110,115,127,136,145,140,129,119,116,120,126,134,144,145,139,126,111,106,107,114,125,135,145,141,130,120,117,120,124,133,143,146,140,128,113,107,107,114,122,134,143,143,130,121,117,120,124,132,143,145,142,129,116,108,109,113,120,132,140,143,130,122,118,120,125,130,142,145,142,132,117,111,108,112,120,131,140,142,131,122,118,120,124,130,141,146,141,132,119,110,109,111,119,129,140,142,132,121,118,120,123,130,139,146,143,132,122,112,110,111,118,129,138,142,132,121,118,119,122,130,139,148,144,133,121,113,109,111,118,130,137,141,133,121,118,118,123,129,140,148,144,134,120,114,109,111,118,128,139,139,133,121,117,118,122,129,140,147,145,134,122,113,111,111,118,129,137,139,131,121,116,120,122,131,138,146,144,132,122,114,113,113,118,127,136,136,131,121,118,121,123,131,138,145,143,133,122,114,115,115,118,126,135,136,130,121,119,121,123,129,138,145,142,136,123,117,114,115,117,125,133,136,129,122,117,121,122,129,138,143,144,137,124,118,115,116,118,124,134,135,130,121,118,120,122,126,137,144,144,138,126,120,117,115,116,125,133,135,132,121,118,118,120,126,135,143,146,138,128,119,117,115,116,125,132,137,131,123,117,117,119,123,135,143,145,140,128,121,117,115,117,125,133,135,131,122,117,117,120,124,135,144,144,139,127,121,119,115,118,124,132,134,130,122,116,118,119,124,135,142,145,138,129,121,120,117,119,124,131,134,130,122,118,118,119,123,133,141,144,140,130,124,121,118,117,124,129,134,130,124,120,118,119,122,132,140,143,141,131,125,122,117,117,121,129,133,131,125,121,119,118,120,131,138,144,142,134,126,124,118,116,121,126,133,131,126,121,120,118,118,129,136,144,143,136,128,125,118,116,119,126,131,132,127,123,120,118,117,126,135,143,143,138,129,125,118,115,118,124,131,133,126,124,119,117,116,125,134,142,144,139,131,125,119,116,118,124,130,131,127,123,120,116,116,125,133,141,145,139,135,126,120,115,118,123,130,133,128,125,121,116,115,122,130,141,144,142,136,127,120,115,118,124,129,133,130,124,120,114,115,121,129,140,145,142,138,129,119,116,117,123,128,134,130,127,120,114,114,120,128,139,144,144,138,131,121,115,118,120,128,132,132,128,121,114,114,119,127,136,145,145,140,132,121,116,116,121,128,133,132,128,121,113,114,118,126,135,145,144,142,132,123,115,116,121,125,133,132,129,121,114,113,118,124,135,143,146,141,134,124,116,115,120,125,132,132,130,121,114,113,118,125,133,143,145,143,135,125,117,116,118,125,131,131,130,123,114,114,117,123,131,142,144,144,135,127,121,116,118,123,130,131,130,124,116,113,118,120,130,140,145,145,136,129,123,118,118,121,129,131,129,125,117,114,118,121,128,137,143,145,138,130,125,119,118,120,128,130,129,126,119,115,117,120,126,134,143,145,139,133,126,121,117,121,125,130,129,126,119,116,117,118,125,133,141,145,140,133,129,123,118,120,123,129,129,127,122,117,118,119,124,133,137,145,141,134,130,123,119,118,124,127,129,126,122,119,118,119,123,131,137,142,141,136,130,126,118,119,123,126,129,126,124,121,119,119,122,130,134,141,142,136,132,127,120,118,123,125,129,126,125,121,120,118,121,128,133,139,143,138,135,129,121,118,120,124,127,128,124,123,119,117,119,125,132,137,143,141,135,130,121,117,120,122,127,128,125,125,120,118,118,124,130,137,142,143,137,131,122,117,118,122,125,129,127,126,121,118,117,123,128,136,142,144,140,133,124,116,118,121,124,128,127,126,121,118,116,122,128,134,142,143,140,132,125,118,119,120,125,128,128,126,122,118,116,122,126,134,140,144,141,133,126,119,119,120,124,129,127,126,123,117,117,120,126,132,140,143,142,134,127,120,119,121,123,129,128,124,124,118,118,120,124,131,137,143,141,137,128,122,119,120,122,128,128,126,124,120,118,118,124,128,137,142,142,139,130,124,119,119,123,126,129,126,125,122,117,118,121,127,134,141,141,140,131,125,119,119,121,127,129,128,126,123,118,118,119,126,133,140,142,139,133,125,120,118,121,125,129,126,128,124,119,118,119,126,132,137,142,141,134,127,120,119,121,124,127,126,128,125,121,118,120,124,131,136,141,141,136,128,122,118,120,123,126,126,128,125,122,118,119,122,130,134,140,142,137,129,122,118,120,122,126,127,130,127,121,119,117,123,128,132,139,142,139,131,122,119,119,121,125,126,130,128,124,119,119,122,126,130,138,142,141,132,125,119,119,120,124,127,130,130,124,121,119,121,124,130,136,142,141,134,126,120,118,121,121,127,129,130,127,121,120,120,123,128,135,140,142,136,127,121,118,119,120,126,129,132,128,123,120,119,122,125,134,140,143,137,129,121,119,118,121,124,130,132,129,124,120,118,121,123,133,139,142,138,130,122,118,118,119,125,129,133,129,125,120,119,120,123,131,140,141,139,130,124,119,118,119,125,129,133,130,125,121,120,119,122,129,138,140,140,132,126,120,117,119,125,130,131,132,125,123,119,120,121,128,137,141,139,133,126,120,117,117,124,127,132,131,128,123,121,119,122,126,136,139,140,134,128,122,117,117,123,127,131,130,128,124,123,120,121,126,133,139,138,136,129,124,118,118,120,126,129,131,128,126,123,120,120,125,131,138,138,137,131,124,120,116,121,124,129,130,130,127,124,120,120,123,131,136,139,138,132,126,120,116,120,124,128,130,130,127,125,121,119,123,128,135,137,138,133,127,120,117,119,123,128,130,131,129,125,122,120,123,127,134,137,139,134,128,122,117,118,123,127,131,131,129,126,123,119,122,126,132,135,139,135,130,123,119,118,121,125,130,131,130,127,124,121,119,125,129,135,139,138,131,125,118,118,119,124,128,132,132,128,125,121,119,124,127,134,138,138,134,125,120,116,119,122,128,132,132,129,126,120,120,122,128,132,139,138,135,127,121,117,118,122,126,132,132,130,126,122,119,123,126,132,138,138,135,128,121,116,117,122,126,131,131,131,126,122,119,122,125,132,136,139,136,129,122,117,118,121,127,131,131,131,126,123,120,123,125,131,136,137,137,130,123,118,118,122,125,130,130,131,128,122,121,121,125,129,136,138,137,131,124,119,117,122,125,130,130,132,127,123,120,122,124,129,135,136,137,132,125,119,118,121,125,129,131,131,129,123,121,120,125,128,133,137,136,133,124,120,117,121,125,129,131,131,129,124,120,121,124,129,134,136,137,132,126,120,117,121,125,130,129,131,129,124,120,121,123,129,132,136,135,134,126,121,118,121,125,130,130,130,130,123,122,121,125,127,131,134,135,132,128,121,121,122,124,129,128,130,128,125,121,122,125,127,131,133,135,133,129,123,122,121,125,127,129,128,129,126,121,123,124,127,130,131,134,133,129,125,123,122,125,127,128,127,129,125,122,124,124,128,129,131,132,133,128,126,123,124,124,128,128,128,129,126,124,124,126,127,129,130,132,132,130,125,125,123,125,126,127,127,128,126,124,124,126,127,129,129,131,131,130,126,125,125,125,127,126,128,128,126,123,124,125,128,128,129,131,131,130,126,126,125,127,128,126,128,126,125,123,124,125,128,128,129,129,131,128,127,127,126,128,127,127,126,127,124,124,124,126,127,129,127,129,129,129,127,128,127,128,128,125,126,125,125,124,125,127,127,128,127,128,129,};

void initDacDriver(void) {
    // shutdown pin
    ANSBbits.ANSB12 = 0; // digital
    TRISBbits.TRISB12 = 0; // output
    ODCBbits.ODB12 = 1; // open drain
    PORTBbits.RB12 = 1; // first toggle off

    // dac setup
    DAC1CONbits.DACEN = 1; // enable 
    DAC1CONbits.DACREF = 0b10; // AVDD ref

    // dma setup channel 0
    DMACONbits.DMAEN = 1; // enable DMA

    // setup dma channel 0
    DMACH0bits.CHEN = 0; // disable it first
    DMACH0bits.TRMODE = 0b01; // repeated one-shot
    DMACH0bits.SIZE = 0; // 16 bits data
    DMACH0bits.DAMODE = 0b00; // destination needs to be untouched
    DMACH0bits.SAMODE = 0b01; // source will be incremented
    DMACH0bits.RELOAD = 0b1;

    // interrupt triggers
    DMAINT0bits.CHSEL = 0b110101; // timer 2 as trigger source

    // look up table
}

void speakerOn(bool on) {
    PORTBbits.RB12 = (on ? 0 : 1);
} 

void setupDMA0(unsigned int *destination, unsigned int *source, uint32_t elementCount) {
    DMASRC0 = (unsigned int)source;
    DMADST0 = (unsigned int)destination;
    DMAL = (unsigned int)source;
    DMAH = (unsigned int)source + elementCount * sizeof(unsigned int);
    DMACNT0 = elementCount; // how much data our buffer will have --> buffer entry count
}

void generateSawToothBufferAndStart(uint32_t sampleFreq, uint32_t desiredFreq, uint32_t peak) {
    // stop it
    DMACH0bits.CHEN = 0;
    
    free(sawBuffer);
    
    startStopTimer2(false);
    initTimer2(16000000, sampleFreq, true);
    startStopTimer2(true);

    // protect adc module
    if(peak > 1024) { peak = 1024; }
    
    sawToothIncrement = (peak * desiredFreq) / (sampleFreq / 1.0);
    sawBufferSize = (unsigned int)(peak / sawToothIncrement);
    sawBuffer = (unsigned int*)calloc(sizeof(unsigned int), sawBufferSize);

    setupDMA0((unsigned int*)&DAC1DAT, sawBuffer, sawBufferSize);

    // generate the wave
    sawBuffer[0] = 0; 
    for(int i = 1; i < sawBufferSize; i++) {
        sawBuffer[i] = sawBuffer[i-1] + sawToothIncrement;
    }

    // start it
    DMACH0bits.CHEN = 1;
}

void generateSineBufferAndStart(uint32_t sampleFreq, uint32_t desiredFreq, uint32_t peak) {
    // stop it
    DMACH0bits.CHEN = 0;

    free(sineBuffer);

    startStopTimer2(false);
    initTimer2(16000000, sampleFreq, true);
    startStopTimer2(true);

    // protect adc module
    if(peak > 1024) { peak = 1024; }

    sineIncrement = (peak * 2.0 * desiredFreq) / (sampleFreq / 1.0);
    sineBufferSize = (unsigned int)(peak / sineIncrement);
    sineBuffer = (unsigned int*)calloc(sizeof(unsigned int), sineBufferSize);

    setupDMA0((unsigned int*)&DAC1DAT, sineBuffer, sineBufferSize);

    for(int i = 0; i < sineBufferSize; i++) {
        sineBuffer[i] = peak * sin(i * ((2*3.1415)/sineBufferSize)) + peak;
    }

    DMACH0bits.CHEN = 1;
}

void playSound(unsigned short int sampleFreq, unsigned short int *sound, uint32_t length) {
    DMACH0bits.CHEN = 0;

    startStopTimer2(false);
    initTimer2(16000000, sampleFreq, true);
    startStopTimer2(true);

    setupDMA0((unsigned int*)&DAC1DAT, sound, length);

    DMACH0bits.CHEN = 1;
}

void playSampleSound() {
    playSound(8000, soundFileLookup, soundFileLookupSize);
}